<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>
    <!-- CSS personalizadas -->
    <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" />
    <!-- Molstar CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-light.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pdbe-molstar@latest/build/pdbe-molstar-plugin.js"></script>
    <style>
        .navbar {
            background-color: #4F80C0;
        }

        .example-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #4F80C0;
            color: white;
            border-radius: 12px;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        .example-button:hover {
            background-color: #0056b3;
        }

        p a, p a:hover{
          color: #BA839B;
          text-decoration: underline;
        }

        p a, p a{
          color: #BA839B;
          text-decoration: none;
        }

        .heatmap { 
            width: 100%;
            margin: 10px 0; 
        }
        .image-container {
            display: flex;
            justify-content: center; 
            margin: 20px auto; 
        }

        .download-button button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #BA839B;
            color: white;
            border-radius: 12px;
            border: none;
            transition: background-color 0.3s ease;
        }
        .download-button button:hover {
            background-color: #0056b3;
        }
        .download-button img {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }

    </style> 
</head>
<body>
<div class="page">
      <div class="header">
        <nav class="navbar navbar-expand-lg navbar-light text-white">
          <a class="navbar-brand" href="/results/search/">
            <h1 class="text-white text-decoration-none">ProteoCast 
              <span style="font-size: 0.6em; color: white;"> for 101</span></h1>
          </a>
          <button class="navbar-toggler" type="button" aria-label="Toggle navigation" aria-controls="navbarNav" data-target="#navbarNav" data-toggle="collapse">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav ml-auto" id="navbarItems">
              <li>
                <a href="/results/download_folder/20250109221806/" class="download-button">
                <button>
                   <img src="/static/browser/images/download_icon.png" alt="Download Icon">
                    Download Results
                </button>
               </a>  
             </li>
            </ul>
          </div>
        </nav>
      </header>
      <div class="content">
        <div class="container-fluid" style="width:95%;">

        <div class="form-row py-4">
            <h5>Here are ProteoCast results for 101. Your job ID is 20250109221806. If you need help in exploring and interpreting them, please go to our <a href="/documentation" target="_blank" rel="noopener noreferrer">documentation</a>.</h5>
        </div>

        <div class="form-row">
            <h2>3D Structure</h2>
            <p> If a UniProt code or a structure is provided, it will be visualized with its B-factors. If the sequence matches the one in the MSA, it can be visualized with GEMME Sensitivity (per-residue GEMME average score) or Residue Class. </p>
        </div>
        <div class="form-row" style="min-height: 600px;">
            <div class="form-group col-10">
                <div id="myViewer" class="viewer-container"></div>
            </div>
            <div class="form-group col-2 pl-5 py-4">
                <div class="buttons">
                    <label>
                        <input type="radio" name="colorToggle" value="bfactor" checked>
                        Color by B-Factors
                    </label>
                    <label>
                        <input type="radio" name="colorToggle" value="gemme">
                        GEMME Sensitivity
                    </label>
                    <label>
                        <input type="radio" name="colorToggle" value="residue_class">
                        Residue Class
                    </label>
                </div>
                <div class="custom-control custom-switch mt-2 py-1">
                    <input type="checkbox" id="segments" name="segments" class="custom-control-input" >
                     <label for="segments" class="custom-control-label text-dark">Highlight Segments</label>
                </div>
            </div>
        </div>
        
        <script>
            // Initialize the viewer
            const viewerInstance = new PDBeMolstarPlugin();
        
            const viewerContainer = document.getElementById('myViewer');
        
            // Define the PDB URLs for each condition
            const pdbUrls = {
                bfactor: "B8JJE0_89179_unrelaxed_rank_001_alphafold2_ptm_model_3_seed_000.pdb",
                gemme: "B8JJE0_89179_unrelaxed_rank_001_alphafold2_ptm_model_3_seed_000_GEMMESensitivity.pdb",
                residue_class: "B8JJE0_89179_unrelaxed_rank_001_alphafold2_ptm_model_3_seed_000_GEMMEResClass.pdb"
            };

            // Define the segments that are 1 (red) or 2 (purple)
            // in regions of low pLDDT -- we do not load a new structure, 
            // we directly encode the selections in the page
            var selectSections = [
                {
                    start_residue_number: 302,
                    end_residue_number: 323,
                    color: {r: 182, g: 132, b: 187 },
                    representation: 'putty',
                    representationColor: {r: 182, g: 132, b: 187 }, // purple
                },
                {
                    start_residue_number: 361,
                    end_residue_number: 377,
                    color: {r: 243, g: 119, b: 140 },
                    representation: 'putty',
                    representationColor: {r: 243, g: 119, b: 140 }, // red
                },
                {
                    start_residue_number: 378,
                    end_residue_number: 400,
                    color: {r: 255, g: 255, b: 255 },
                    representation: 'putty',
                    representationColor: {r: 255, g: 255, b: 255 }, // white, a segment at zero just to see the contrast for the size of the putty
                },
                {
                    start_residue_number: 401,
                    end_residue_number: 415,
                    color: {r: 182, g: 132, b: 187 },
                    representation: 'putty',
                    representationColor: {r: 182, g: 132, b: 187 }, // purple
                }
            ];
        
            // Options for the Mol* Viewer
            var options = {
                customData: { url: '', format: 'pdb' }, // URL will be dynamically updated
                alphafoldView: true,
                bgColor: { r: 255, g: 255, b: 255 },
                hideCanvasControls: [
                    'selection', 'animation', 'controlToggle', 'controlInfo', 
                    'controlZoom', 'controlRotate', 'controlTranslate', 
                    'controlReset', 'controlFullscreen'
                ],
                layoutIsExpanded: false,
                hideControls: true, // Hide the toolbar
                visualStyle: {
                    polymer: {type: 'cartoon', size:'uniform'},
                },
            };

        // Function to load the structure and apply coloring
        async function initialiseView(condition='bfactor') {

            console.log("Loading structure for condition:", condition);
            console.log("PDB URL:", pdbUrls[condition]);
            options.customData.url = pdbUrls[condition]; // Set the PDB URL
            console.log("Applying B-Factor coloring");
            options.visualStyle.polymer.color = 'plddt-confidence';
            // Wait for the render process to complete
            await viewerInstance.render(viewerContainer, options);
            // Now it's safe to access properties
            console.log("Viewer instance initialized");
            console.log(viewerInstance.plugin.canvas3d); // Should now exist
            viewerInstance.plugin.canvas3d?.setProps({ camera: { manualReset: true } });
        }

        async function addStructure(condition){

            viewerInstance.plugin.clear();
            const _data = await viewerInstance.plugin.builders.data.download({ url: pdbUrls[condition] }, { state: { isGhost: true } });
            const trajectory = await viewerInstance.plugin.builders.structure.parseTrajectory(_data, 'pdb');
            const model = await viewerInstance.plugin.builders.structure.createModel(trajectory);
            const structure = await viewerInstance.plugin.builders.structure.createStructure(model);
            const all = await viewerInstance.plugin.builders.structure.tryCreateComponentStatic(structure, 'all');
            if (all) {
                if (condition === 'bfactor') {
                    await viewerInstance.plugin.builders.structure.representation.addRepresentation(all, { type: 'cartoon', color: 'plddt-confidence'});
                }
                else{
                    await viewerInstance.plugin.builders.structure.representation.addRepresentation(all, { type: 'cartoon', color: 'uncertainty'});
                }
            }
        }

        // Function to load the structure and apply coloring
        async function loadStructureAndColor(condition) {
            console.log("Loading structure for condition:", condition);
            console.log("PDB URL:", pdbUrls[condition]);
            addStructure(condition);

            // Restore the camera state -- not needed anymore
/*            if (cameraState) {
                console.log("about to update...",cameraState);
                viewerInstance.plugin.canvas3d?.camera.setState(cameraState);
                console.log("updated...",viewerInstance.plugin.canvas3d?.camera.getSnapshot());
            }*/

        }
        
        var checkbox = document.querySelector('input[name="segments"]');
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                console.log("Checkbox is checked..");
                viewerInstance.visual.select({data: selectSections});

                } else {
                    console.log("Checkbox is not checked..");
                    viewerInstance.visual.clearSelection();
                     }
                 });

            // Add event listeners to the radio buttons
           document.querySelectorAll('input[name="colorToggle"]').forEach(button => {
                button.addEventListener('change', function () {
                    // Get the camera state -- not needed anymore
/*                  const cameraState = viewerInstance.plugin.canvas3d?.camera.getSnapshot()
                    console.log("camera state before");
                    console.log(cameraState);*/
                    checkbox.checked = false;
                    loadStructureAndColor(this.value);
                });
            });

        
            // Initial load (default to B-Factors)
           initialiseView();

        </script>
       
    </div>

       
      <footer class="bg-light text-center py-3">
            <p class="mb-0">ProteoCast - This website is free and open to all users and there is no login requirement.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          const footer = document.querySelector('footer');
          footer.style.display = 'none'; // Initially hide the footer
    
          window.addEventListener('scroll', function () {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
              footer.style.display = 'block'; // Show the footer when scrolled to the bottom
            } else {
              footer.style.display = 'none'; // Hide the footer otherwise
            }
          });
        });
        </script>

    </div>
  </body></html>