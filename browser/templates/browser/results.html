{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Molstar CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-3.1.0.css">
    <script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.0.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body class="d-flex flex-column align-items-center">
    <header class="w-100 bg-light py-3 mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="m-0">
                <a href="{% url 'drosophiladb' %}" class="text-decoration-none text-dark">ProteoCast for {{ query }}</a>
            </h1>
            <a href="{% url 'download_file' fbpp_id=query %}" class="btn btn-outline-primary">
                <img src="{% static 'browser/images/download_icon.png' %}" alt="Download Icon" class="me-2" style="width: 20px; height: 20px;">
                Download Results
            </a>
        </div>
    </header>

    <main class="container text-center mb-5">
        <section class="mb-5">
            {% if heatmap_html %}
                <h2>Mutational Landscape</h2>
                <p>The following matrix represents the predicted effects of all possible mutations (rows) at each position (columns) of a protein sequence:</p>
                <div>{{ heatmap_html|safe }}</div>
            {% else %}
                <p>No results found.</p>
            {% endif %}
        </section>

        <section class="mb-5">
            <h2>GMM Profile</h2>
            <p>To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations.</p>
            {% if image_url_1 %}
                <img src="{{ image_url_1 }}" alt="GMM" class="img-fluid rounded shadow">
            {% endif %}
        </section>

        <section class="mb-5">
            <h2>3D Protein Structure</h2>
            <div id="myViewer" class="mx-auto" style="width: 100%; max-width: 800px; height: 450px;"></div>
            <script>
                var viewerInstance = new PDBeMolstarPlugin();
                var options = {
                    customData: {
                       url: "{% static 'jobs/' %}{{ query }}/{{ query }}.pdb",
                       format: 'pdb'
                    },
                    alphafoldView: true,
                    bgColor: { r: 255, g: 255, b: 255 },
                    hideCanvasControls: ['selection', 'animation', 'controlToggle', 'controlInfo'],
                    layoutIsExpanded: false
                };
                var viewerContainer = document.getElementById('myViewer');
                viewerInstance.render(viewerContainer, options);

                function colorResidues(residueData) {
                    viewerInstance.visual.select({
                       data: residueData.map(function(residue) {
                          return { residue_number: residue.residue_number, color: `rgb(${residue.color.r}, ${residue.color.g}, ${residue.color.b})` };
                       })
                    });
                }

                window.onload = function() {
                   var residueFileUrl = "{% static 'jobs/' %}{{ query }}/residue_colors.txt";

                   setTimeout(function() {
                       fetch(residueFileUrl)
                          .then(response => response.json())
                          .then(data => {
                               colorResidues(data);
                           })
                           .catch(error => console.error("Error loading residue file:", error));
                   }, 2000);
               };
            </script>
        </section>

        <section class="mb-5">
            <h2>Segmentation Profile</h2>
            <p>To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations.</p>
            {% if fig_segmentation %}
                <img src="{{ fig_segmentation }}" alt="Segmentation" class="img-fluid rounded shadow">
            {% endif %}
        </section>

        <section class="mb-5">
            <h2>MSA Representation</h2>
            {% if fig_msarep %}
                <img src="{{ fig_msarep }}" alt="MSA Representation" class="img-fluid rounded shadow">
            {% endif %}
        </section>
    </main>

    <footer class="w-100 bg-light py-3 text-center">
        <p class="m-0">ProteoCast - This website is free and open to all users, and there is no login requirement.</p>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
