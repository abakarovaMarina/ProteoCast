{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>

    <!-- Molstar CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-3.1.0.css">
    <script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.0.js"></script>

    <!-- CSS personalizadas -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link crossorigin="anonymous" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" />

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f8f9fa;
        } 
        .main-content {
            flex-grow: 1;
            width: 100%;
            padding: 20px;
        }
        .results-container {
            display: flex;
            flex-direction: column; 
            align-items: center;   
            margin: 20px;
            gap: 20px;
            width: 90%;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .images-flex-container {
           display: flex;
           flex-direction: column;
           align-items: center; 
           margin-top: 20px;
        }
        .results-container h2,
        .results-container p,
        .images-flex-container h2,
        .images-flex-container p {
            text-align: center;
            margin: 0;
        }
        .heatmap { 
            width: 100%;
            margin: 10px 0; 
        }
        .image-container {
            display: flex;
            justify-content: center; 
            margin: 20px auto; 
        }
        .result-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0; 
            display: block;
        }
        footer {
            width: 100%;
            text-align: center;
            padding: 10px;
            background-color: #f1f1f1;
            position: fixed;
            bottom: 0;
            color: grey;
        }
        #myViewer {
            width: 100%;
            height: 450px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }
        .download-button button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border-radius: 12px;
            border: none;
            transition: background-color 0.3s ease;
        }
        .download-button button:hover {
            background-color: #0056b3;
        }
        .download-button img {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            margin-right: 10px;
        }
        #colorBFactorBtn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border-radius: 12px;
            border: none;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        #colorBFactorBtn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content" style="display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 20px; background-color: #343a40; color: white;">
            <div class="header-text" style="flex-grow: 1;">
                <h1 style="font-size: 2em; text-align: left;">
                    <a href="{% url 'drosophiladb' %}" style="text-decoration: none; color: white;">ProteoCast for {{ prot_name }}</a> 
                </h1>
            </div>
            <a href="{% url 'download_folder' fbpp_id=query %}" class="download-button">
                <button>
                    <img src="{% static 'browser/images/download_icon.png' %}" alt="Download Icon">
                    Download Results
                </button>
            </a>
        </div>
    </header>

    <div class="main-content">
        <div class="results-container">
            {% if heatmap_html %}
            <div class="heatmap">
                <h2>Mutational Landscape</h2>
                <p>The following matrix represents the predicted effects of all possible mutations (rows) at each position (columns) of a protein sequence</p>
                {{ heatmap_html|safe }}
            </div>
            {% else %}
            <p>No results found.</p>
            {% endif %}
            
            <div class="images-flex-container">
                <h2>GMM profile</h2>
                <p>To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations. The GMM identifies patterns in the distribution of mutational effects by modeling the data as a mixture of Gaussian distributions</p>
                {% if image_url_1 %}
                <div class="image-container">
                    <img src="{{ image_url_1 }}" alt="GMM" class="result-image">
                </div>
                {% endif %}
            </div>
        </div>

        <h2 style="text-align: center; margin-top: 40px;">3D Protein Structure</h2>
        <div id="myViewer"></div>
        <button id="colorBFactorBtn">Color by B-Factors</button>

        <script>
            var viewerInstance = new PDBeMolstarPlugin();

            var options = {
                customData: {
                    url: "{{ pdb_url_1 }}", // Dynamically set PDB URL from Django context
                    format: 'pdb'
                },
                alphafoldView: true,
                bgColor: { r: 255, g: 255, b: 255 },
                hideCanvasControls: ['selection', 'animation', 'controlToggle', 'controlInfo'],
                layoutIsExpanded: false
            };

            var viewerContainer = document.getElementById('myViewer');
            viewerInstance.render(viewerContainer, options);

            // Function to apply coloring based on B-factor
            function applyBFactorColoring() {
                viewerInstance.visual.setColor({
                    color: {
                        name: 'bfactor',
                        params: {
                            list: [
                                { value: 0, color: { r: 0, g: 0, b: 255 } },   // Blue for minimum
                                { value: 50, color: { r: 255, g: 255, b: 255 } }, // White for middle
                                { value: 100, color: { r: 255, g: 0, b: 0 } }  // Red for maximum
                            ],
                            min: 0,
                            max: 100
                        }
                    }
                });
            }

            // Add click event to the button
            document.getElementById('colorBFactorBtn').addEventListener('click', function() {
                applyBFactorColoring();
            });

            // Optional: Log to console when structure is loaded
            viewerInstance.events.loadComplete.subscribe(() => {
                console.log("Structure loaded! Click the button to color by B-factors.");
            });
        </script>

        <div class="results-container">
            <div class="images-flex-container">
                <h2>Segmentation profile</h2>
                <p>To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations. The GMM identifies patterns in the distribution of mutational effects by modeling the data as a mixture of Gaussian distributions</p>
                {% if fig_segmentation %}
                <div class="image-container">
                    <img src="{{ fig_segmentation }}" alt="Segmentation" class="result-image">
                </div>
                {% endif %}
            </div>
            <div class="images-flex-container">
                <h2>MSA Representation</h2>
                <p>To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations. The GMM iden></p>
                {% if fig_msarep %}
                <div class="image-container">
                    <img src="{{ fig_msarep }}" alt="MSA Representation" class="result-image">
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <footer>
        <p>ProteoCast - This website is free and open to all users and there is no login requirement.</p>
    </footer>
</body>
</html>
