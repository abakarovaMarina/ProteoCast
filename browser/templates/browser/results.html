{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results</title>

    <!-- Molstar CSS & JS -->
    <link rel="stylesheet" type="text/css" href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-3.1.0.css">
    <script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.0.js"></script>

    <!-- CSS personalizadas -->
    <link rel="stylesheet" type="text/css" href="{% static 'browser/styles.css' %}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        } 
        .main-content {
            flex-grow: 1;
            width: 100%;
        }
        .results-container {
            display: flex;
            flex-direction: column; 
            align-items: center;   
            margin: 20px;
            gap: 20px;
            width: 90%;
        }

        .heatmap {
            margin-bottom: 20px; /* Add margin bottom to create space */
        }
        .image-container {
            margin-top: 20px; /* Add margin top to create space */
        }
        .image-container {
            margin-bottom: 50px; /* Add margin top to create space */
        }
        footer {
            width: 100%;
            height: 50px;
            text-align: center;
            padding: 10px;
            background-color: #3d81c5;
            position: relative;
            bottom: 0;
        }
        #myViewer {
            float: left;
            width: 1000px;
            height: 450px;
            margin-top: 80px;
            position: relative;
        }
    </style>


</head>
<body>
    <header>
        <div class="header-content" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="header-text">
                <h1>ProteoCast for {{ query }}</h1>
            </div>
            <a href="{% url 'download_file' fbpp_id=query %}" class="download-button" style="margin-right: 20px;">
                <button style="padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: white; border-radius: 12px; border: 1px solid #ccc;">
                    <img src="{% static 'browser/images/download_icon.png' %}" alt="Download Icon" style="width: 43px; height: 40px; vertical-align: middle; margin-right: 2px;">
                    Download Results
                </button>
            </a>
        </div>
    </header>

    <div class="main-content">
        <div class="results-container">
            {% if heatmap_html %}
            
            <div class="heatmap">
                <h2>Mutational Landscape</h2>
                <p>The following matrix represents the predicted effects of all possible mutations (rows) at each position (columns) of a protein sequence</p>
                {{ heatmap_html|safe }}
            </div>
            {% else %}
            <p>No results found.</p>
            {% endif %}

            <div class="images-flex-container">
                <h2 style="margin-left: 3cm;">GMM profile</h2>
                <p style="margin-left: 3cm;">To better interpret mutational landscapes, we use a Gaussian Mixture Model (GMM) to cluster mutation effect scores into distinct categories, such as tolerant, intermediate, and sensitive mutations. The GMM identifies patterns in the distribution of mutational effects by modeling the data as a mixture of Gaussian distributions</p>

            {% if image_url_1 %}
                <div class="image-container" style="margin-left: 2cm; margin-top:1cm;">
                <img src="{{ image_url_1 }}" alt="GMM" class="result-image">
                </div>
            {% endif %}
            </div>
        </div>
        <h2 style="margin-bottom:1.5cm; margin-left: 3cm;"> 3D Protein Structure </h2>
        
        <!-- Molstar Viewer Container -->
        <div id="myViewer" style="margin-left: 3cm;"></div>
            
        <script>
            // Crear el contenedor para el visor
            var viewerInstance = new PDBeMolstarPlugin();

            var options = {
                customData: {
                    url: "{% static 'jobs/' %}{{ query }}/{{ query }}.pdb",  // URL del archivo PDB
                    format: 'pdb'
                },
                alphafoldView: true,  // Activar vista AlphaFold si es necesario
                bgColor: { r: 255, g: 255, b: 255 },  // Fondo blanco
                hideCanvasControls: ['selection', 'animation', 'controlToggle', 'controlInfo']  // Controles ocultos
            };

            var viewerContainer = document.getElementById('myViewer');
            viewerInstance.render(viewerContainer, options);

            // Función para colorear los residuos
            function colorResidues(residueData) {
                viewerInstance.visual.select({
                    data: residueData.map(function(residue) {
                        return { residue_number: residue.number, color: residue.color };
                    })
                });
            }

            window.onload = function() {
                setTimeout(function() {
                    // Ejemplo de cómo colorear residuos (esto debe adaptarse a los datos reales)
                    colorResidues([
                        { number: 1, color: 'red' },
                        { number: 2, color: 'blue' },
                        { number: 3, color: 'green' }
                    ]);
                }, 1000); // Un pequeño retraso para garantizar que el visor cargue primero
            };
        </script>
    </div>
    <footer>
        <p> ProteoCast </p>
    </footer>
</body>
</html>
